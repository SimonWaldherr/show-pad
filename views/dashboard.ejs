<% layout('layout.ejs') %>
<% block('title', __('dashboard')) -%>

<!-- DataTables -->
<% script('js/jquery.jeditable.mini.js') %>
<% script('js/jquery.dataTables.editable.js') %>
<% script('http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.js') %>
<% stylesheet('http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css') %> 

<!-- ShowPad -->
<% stylesheet('css/dashboard.css') %>

<!-- Bootstrap-like select -->
<% script('js/bootstrap-select.min.js') %>
<% stylesheet('css/bootstrap-select.min.css') %> 

<% script('http://twitter.github.com/bootstrap/1.4.0/bootstrap-tabs.js') %>

<div id="tabs">
  <ul class="nav nav-tabs" data-tabs="tabs">
    <li class="active"><a href="#users" data-toggle="tab"><%= __('dashboard.users') %></a></li>
    <li><a href="#docs" data-toggle="tab"><%= __('dashboard.docs') %></a></li>
  </ul>
  <div id="my-tab-content" class="tab-content">
    <div class="tab-pane active" id="users">
        <table id="usertable">
            <thead>
                <th><%= __('dashboard.users.name') %></th>
                <th><%= __('dashboard.users.email') %></th>
                <th><%= __('dashboard.users.role') %></th>
                <th><%= __('dashboard.users.status') %></th>
            </thead>
        </table>
    </div>
    <div class="tab-pane" id="docs">
        <table id="padtable">
            <thead>
                <th><%= __('dashboard.docs.name') %></th>
                <th><%= __('dashboard.docs.type') %></th>
            </thead>
        </table>
        <br>
        <div "newdoc">
            <h3><%= __('dashboard.docs.create') %></h3>
            <div class="alert alert-error" id="create-error" style="display:none"></div>
            <div class="form-inline">
                <label class="control-label" for="docname"><%= __('dashboard.docs.create.name') %></label>
                <input type="text" id="docname" name="docname">

                <label class="control-label" for="doctype"><%= __('dashboard.docs.create.type') %></label>
                <select id="doctype" name="doctype" class="selectpicker">
                    <option value="etherpad">Etherpad</option>
                </select>
                
                <button class="btn primary" type="submit" id="create-doc"><%= __('dashboard.docs.create.submit') %></button>
            </div>
        </div>
    </div>
</div>

<script>
$('select').selectpicker();

$('#create-doc').click(function ()
{
    $.post('api/1/docs', { docname: $('#docname').val(), type: $('#doctype').val() })
        .done(function (res)
            {
                var doc = JSON.parse(res).data;
                padtable.fnAddData(
                    {
                        docname: doc.docname,
                        type: doc.type
                    });
                $('#create-error').hide();
            })
        .fail(function (res)
            {
                var msg = JSON.parse(res.responseText).message;
                switch(msg)
                {
                    case "docexists":
                        $('#create-error').text("<%= __('dashboard.docs.create.error.exists') %>");
                        break;
                    default:
                        $('#create-error').text("<%= __('dashboard.docs.create.error.other') %>");
                        break;
                }
                $('#create-error').show();
            });
})

$.fn.dataTableExt.sErrMode = 'throw';

padtable = $('#padtable')
    .dataTable(
    {
        "bProcessing": true,
        "sAjaxSource": "/api/1/docs/?datatables=1",
        "sAjaxDataProp": "data",
        "aoColumns": [
          { "mData": [ "docname" ] },
          { "mData": [ "type" ] }
        ]
    });

$('#usertable')
    .dataTable(
    {
        "bProcessing": true,
        "sAjaxSource": "/api/1/users/?datatables=1",
        "sAjaxDataProp": "data",
        "aoColumns": [
          { "mData": [ "username" ] },
          { "mData": [ "email" ] },
          {
            "mData": [ "roles" ],
            "fnRender": function (oObj)
                {
                    if(oObj.aData.roles["admin"] || oObj.aData.roles == "Admin")
                        return "Admin";
                    if(oObj.aData.roles["user"] || oObj.aData.roles == "User")
                        return "User";
                },
          },
          {
            "mData": [ "status" ],
            "fnRender": function (oObj)
                {
                    var status = oObj.aData.status;
                    status = status.charAt(0).toUpperCase() + status.slice(1);
                    return status;
                },
          }
        ]
    })
    .makeEditable(
    {
        "sUpdateURL": '/api/1/users/?datatables=1',
        "aoColumns":
        [
            null,
            null,
            {
                event: 'click',
                indicator: '<%= __('dashboard.users.selectrole') %>',
                loadtext: 'loading...',
                type: 'select',
                onblur: 'submit',
                data: "{'admin':'Admin','user':'User'}"
            },
            {
                event: 'click',
                indicator: '<%= __('dashboard.users.selectstatus') %>',
                loadtext: 'loading...',
                type: 'select',
                onblur: 'submit',
                data: "{'banned':'Banned','email':'Email','normal':'Normal'}"
            }
        ]
    });
</script>
 